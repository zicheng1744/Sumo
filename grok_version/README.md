# SUMO-RL 训练工具

## 问题描述
原先的代码在运行时会出现 "Connection closed by SUMO" 错误，导致训练无法正常进行。

## 解决方案

### 1. 问题原因分析
主要问题包括：
- SUMO连接不稳定，导致训练中断
- 环境变量配置不正确
- 车辆ID使用问题导致冲突
- 异常处理不完善
- 初始化时机不合适

### 2. 修复内容

1. **完善的错误处理**：
   - 增加了try-except结构捕获TRACI错误
   - 添加了重试机制
   - 增加了错误日志输出

2. **资源管理优化**：
   - 在关闭连接后增加等待时间，确保资源释放
   - 修复了环境变量设置问题

3. **车辆ID冲突解决**：
   - 对主路和匝道车辆分别使用独立的计数器
   - 确保车辆ID唯一

4. **奖励函数优化**：
   - 增加了更详细的奖励计算
   - 添加了调试输出，便于分析训练过程

5. **合理的初始化顺序**：
   - 分离了环境检查和初始化过程
   - 添加了need_reset参数控制初始化行为

## 使用说明

### 准备工作
1. 确保SUMO已正确安装
2. 检查test_training_fixed.py中的SUMO_HOME路径是否与您的安装位置一致

### 运行方法

#### 方法1：使用批处理文件
直接双击run_training.bat运行，它会自动执行以下操作：
1. 生成新的随机车流
2. 运行修复版的训练脚本

#### 方法2：单独运行脚本

1. 首先生成随机车流：
```
python generate_random_traffic.py --main_prob 0.5 --ramp_prob 0.3 --cav_prob 0.4 --duration 100
```

参数说明：
- main_prob：主路车辆生成概率
- ramp_prob：匝道车辆生成概率
- cav_prob：智能车辆比例
- duration：模拟时长
- speed：车辆最大速度（默认8.0）
- accel：加速度（默认3.0）
- decel：减速度（默认5.0）

2. 然后运行训练脚本：
```
python test_training_fixed.py
```

3. 测试已训练的模型（可选）：
```
# 修改test_training_fixed.py，取消test_saved_model()的注释
python test_training_fixed.py
```

## 注意事项
- 如果仍然出现连接问题，可以尝试增加重试次数和等待时间
- 训练过程中可通过控制台输出监控训练状态
- 若出现环境检查失败但能够训练，说明环境配置可能有小问题，但不影响使用 